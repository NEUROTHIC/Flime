<script>
    class FlimeMessenger {
        constructor() {
            const currentUrl = window.location.origin + window.location.pathname;
            const baseUrl = currentUrl.endsWith('/') ? currentUrl : currentUrl + '/';
            
            // –í–∞—à —Ä–µ–∞–ª—å–Ω—ã–π VK App ID
            this.VK_APP_ID = '54294498';
            this.VK_REDIRECT_URI = baseUrl;
            
            this.init();
        }

        init() {
            this.initializeElements();
            this.setupEventListeners();
            this.initializeApp();
        }

        initializeElements() {
            // –í—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã DOM
            this.messagesContainer = document.getElementById('messagesContainer');
            this.messageInput = document.getElementById('messageInput');
            this.sendButton = document.getElementById('sendButton');
            this.sidebar = document.getElementById('sidebar');
            this.openSidebar = document.getElementById('openSidebar');
            this.closeSidebar = document.getElementById('closeSidebar');
            this.sidebarOverlay = document.getElementById('sidebarOverlay');
            this.menuToggle = document.getElementById('menuToggle');
            this.slideMenu = document.getElementById('slideMenu');
            this.closeMenu = document.getElementById('closeMenu');
            this.chatOverlay = document.getElementById('chatOverlay');
            this.searchToggle = document.getElementById('searchToggle');
            this.searchContainer = document.getElementById('searchContainer');
            this.searchField = document.getElementById('searchField');
            this.searchClose = document.getElementById('searchClose');
            this.searchResults = document.getElementById('searchResults');
            this.callScreen = document.getElementById('callScreen');
            this.startCallBtn = document.getElementById('startCallBtn');
            this.chatActions = document.getElementById('chatActions');
            this.minimizeCallBtn = document.getElementById('minimizeCall');
            this.endCallBtn = document.getElementById('endCallBtn');
            this.callMuteBtn = document.getElementById('callMuteBtn');
            this.callSpeakerBtn = document.getElementById('callSpeakerBtn');
            this.callTimer = document.getElementById('callTimer');
            this.callContactName = document.getElementById('callContactName');
            this.callAvatar = document.getElementById('callAvatar');
            this.currentChatName = document.getElementById('currentChatName');
            this.currentChatStatus = document.getElementById('currentChatStatus');
            this.currentChatAvatar = document.getElementById('currentChatAvatar');
            this.chatArea = document.getElementById('chatArea');
            this.contactsList = document.getElementById('contactsList');
            this.vkAuthBtn = document.getElementById('vkAuthBtn');
            this.authStatus = document.getElementById('authStatus');
            this.userProfile = document.getElementById('userProfile');
            this.userName = document.getElementById('userName');
            this.userUsername = document.getElementById('userUsername');
            this.userAvatar = document.getElementById('userAvatar');
            this.logoutBtn = document.getElementById('logoutBtn');
            this.vkAuthContainer = document.getElementById('vkAuthContainer');
            this.profileMenuItem = document.getElementById('profileMenuItem');
            this.notification = document.getElementById('notification');

            this.currentChat = null;
            this.callSeconds = 0;
            this.callInterval = null;
            this.isCallMinimized = false;
            this.isDragging = false;
            this.dragOffset = { x: 0, y: 0 };
            this.isVKAuthenticated = false;
            this.userData = null;
            this.vkAccessToken = null;
            this.vkFriends = [];
        }

        // –î–∞–Ω–Ω—ã–µ —á–∞—Ç–æ–≤
        chatData = {
            'favorites': {
                id: 'favorites',
                name: '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ',
                status: '–ü–æ—Å–ª–µ–¥–Ω–∏–µ –≤–∞–∂–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è',
                avatar: 'fas fa-star',
                canCall: false,
                username: null,
                vkId: null
            }
        };

        chatMessages = {
            'favorites': [
                { text: '–ü—Ä–∏–≤–µ—Ç! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Flime Messenger!', isSent: false, timestamp: Date.now() - 3600000 },
                { text: '–°–ø–∞—Å–∏–±–æ! –ó–¥–µ—Å—å –æ—á–µ–Ω—å –∫—Ä—É—Ç–æ–π –¥–∏–∑–∞–π–Ω!', isSent: true, timestamp: Date.now() - 3500000 },
                { text: '–ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å —á–µ—Ä–µ–∑ VK –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º –∏ –∑–≤–æ–Ω–∫–∞–º', isSent: false, timestamp: Date.now() - 3400000 }
            ]
        };

        setupEventListeners() {
            this.messageInput.addEventListener('input', () => this.autoResizeTextarea());
            this.sendButton.addEventListener('click', () => this.sendMessage());
            this.messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.sendMessage();
                }
            });

            this.openSidebar.addEventListener('click', () => this.toggleSidebar(true));
            this.closeSidebar.addEventListener('click', () => this.toggleSidebar(false));
            this.sidebarOverlay.addEventListener('click', () => this.toggleSidebar(false));
            this.menuToggle.addEventListener('click', () => this.toggleSlideMenu(true));
            this.closeMenu.addEventListener('click', () => this.toggleSlideMenu(false));
            this.chatOverlay.addEventListener('click', () => this.toggleSlideMenu(false));

            this.searchToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                this.openSearch();
            });
            this.searchClose.addEventListener('click', (e) => {
                e.stopPropagation();
                this.closeSearch();
            });
            this.searchField.addEventListener('input', () => this.handleSearch());
            this.searchField.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') this.closeSearch();
            });

            this.startCallBtn.addEventListener('click', () => this.startCall());
            this.minimizeCallBtn.addEventListener('click', () => this.toggleCallMinimize());
            this.endCallBtn.addEventListener('click', () => this.endCall());
            this.callMuteBtn.addEventListener('click', () => this.toggleCallControl(this.callMuteBtn, 'fas fa-microphone-slash', 'fas fa-microphone'));
            this.callSpeakerBtn.addEventListener('click', () => this.toggleCallControl(this.callSpeakerBtn, 'fas fa-volume-mute', 'fas fa-volume-up'));

            this.vkAuthBtn.addEventListener('click', () => this.initVKAuth());
            this.logoutBtn.addEventListener('click', () => this.logout());
            this.profileMenuItem.addEventListener('click', () => this.showProfile());

            this.setupCallDragging();

            document.addEventListener('click', (e) => {
                if (this.searchContainer.classList.contains('active') && 
                    !this.searchContainer.contains(e.target) && 
                    e.target !== this.searchToggle) {
                    this.closeSearch();
                }
            });

            window.addEventListener('resize', () => this.handleWindowResize());
            window.addEventListener('beforeunload', () => this.cleanup());
            this.handleOAuthCallback();
        }

        initializeApp() {
            this.renderContacts();
            this.updateSendButtonState();
            this.checkExistingAuth();
        }

        // –†–ï–ê–õ–¨–ù–ê–Ø VK –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø
        initVKAuth() {
            // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ scope –¥–ª—è —Ä–∞–±–æ—Ç—ã –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞
            const scope = 'friends,offline';
            
            const authUrl = `https://oauth.vk.com/authorize?` +
                `client_id=${this.VK_APP_ID}&` +
                `display=page&` +
                `redirect_uri=${encodeURIComponent(this.VK_REDIRECT_URI)}&` +
                `scope=${scope}&` +
                `response_type=token&` +
                `v=5.199&` +
                `state=flime_messenger`;

            this.vkAuthBtn.classList.add('loading');
            this.authStatus.textContent = '–û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è VK...';

            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            const width = 600;
            const height = 700;
            const left = (screen.width - width) / 2;
            const top = (screen.height - height) / 2;

            const authWindow = window.open(
                authUrl,
                'VK Auth',
                `width=${width},height=${height},left=${left},top=${top}`
            );

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∫–∞–∂–¥—ã–µ 500ms
            const checkAuth = setInterval(() => {
                if (authWindow.closed) {
                    clearInterval(checkAuth);
                    this.vkAuthBtn.classList.remove('loading');
                    this.authStatus.textContent = '–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞';
                }
            }, 500);
        }

        handleOAuthCallback() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);

            if (params.has('access_token')) {
                this.vkAccessToken = params.get('access_token');
                const userId = params.get('user_id');
                
                this.showNotification('–£—Å–ø–µ—à–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è! –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ...', 'success');
                this.fetchVKUserData(userId);
            }
        }

        async fetchVKUserData(userId) {
            try {
                const response = await fetch(
                    `https://api.vk.com/method/users.get?` +
                    `user_ids=${userId}&` +
                    `fields=photo_200,screen_name,domain,online,can_call&` +
                    `access_token=${this.vkAccessToken}&` +
                    `v=5.199`
                );

                const data = await response.json();
                
                if (data.error) {
                    this.showNotification('–û—à–∏–±–∫–∞ VK API: ' + data.error.error_msg, 'error');
                    return;
                }
                
                if (data.response && data.response[0]) {
                    const user = data.response[0];
                    this.userData = {
                        id: user.id,
                        firstName: user.first_name,
                        lastName: user.last_name,
                        photo: user.photo_200,
                        username: '@' + (user.screen_name || user.domain || `id${user.id}`),
                        online: user.online,
                        canCall: user.can_call
                    };
                    
                    this.handleSuccessfulAuth();
                    // –û—á–∏—â–∞–µ–º URL –æ—Ç —Ç–æ–∫–µ–Ω–∞
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', error);
                this.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
            }
        }

        async fetchVKFriends() {
            if (!this.vkAccessToken) return;

            try {
                const response = await fetch(
                    `https://api.vk.com/method/friends.get?` +
                    `fields=photo_200,domain,online,last_seen,can_call&` +
                    `access_token=${this.vkAccessToken}&` +
                    `v=5.199`
                );

                const data = await response.json();
                
                if (data.error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥—Ä—É–∑–µ–π:', data.error);
                    return;
                }
                
                if (data.response && data.response.items) {
                    this.vkFriends = data.response.items;
                    this.addVKContacts();
                    this.showNotification(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${this.vkFriends.length} –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤`, 'success');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥—Ä—É–∑–µ–π:', error);
                this.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤', 'error');
            }
        }

        handleSuccessfulAuth() {
            this.isVKAuthenticated = true;
            this.vkAuthContainer.style.display = 'none';
            this.userProfile.style.display = 'flex';
            this.userName.textContent = `${this.userData.firstName} ${this.userData.lastName}`;
            this.userUsername.textContent = this.userData.username;
            
            if (this.userData.photo) {
                this.userAvatar.innerHTML = `<img src="${this.userData.photo}" style="width: 100%; height: 100%; border-radius: 50%;" alt="Avatar">`;
            }

            this.authStatus.textContent = `–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∫–∞–∫ ${this.userData.firstName} ${this.userData.lastName}`;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥—Ä—É–∑–µ–π
            this.fetchVKFriends();
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
            localStorage.setItem('vk_access_token', this.vkAccessToken);
            localStorage.setItem('vk_user_data', JSON.stringify(this.userData));
        }

        addVKContacts() {
            // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ VK –∫–æ–Ω—Ç–∞–∫—Ç—ã
            Object.keys(this.chatData).forEach(key => {
                if (key.startsWith('vk_')) {
                    delete this.chatData[key];
                    delete this.chatMessages[key];
                }
            });

            // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∞–ª—å–Ω—ã—Ö –¥—Ä—É–∑–µ–π –∏–∑ VK
            this.vkFriends.forEach(friend => {
                const contactId = `vk_${friend.id}`;
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                let status = '–ù–µ –≤ —Å–µ—Ç–∏';
                if (friend.online) {
                    status = '–í —Å–µ—Ç–∏';
                } else if (friend.last_seen) {
                    const lastSeen = new Date(friend.last_seen.time * 1000);
                    const now = new Date();
                    const diffHours = Math.floor((now - lastSeen) / (1000 * 60 * 60));
                    
                    if (diffHours < 1) status = '–ë—ã–ª(–∞) –Ω–µ–¥–∞–≤–Ω–æ';
                    else if (diffHours < 24) status = `–ë—ã–ª(–∞) ${diffHours} —á. –Ω–∞–∑–∞–¥`;
                    else status = `–ë—ã–ª(–∞) ${Math.floor(diffHours / 24)} –¥. –Ω–∞–∑–∞–¥`;
                }

                this.chatData[contactId] = {
                    id: contactId,
                    name: `${friend.first_name} ${friend.last_name}`,
                    status: status,
                    avatar: friend.photo_200 ? `url("${friend.photo_200}")` : 'fas fa-user',
                    canCall: friend.can_call === 1,
                    username: '@' + (friend.domain || `id${friend.id}`),
                    vkId: friend.id
                };

                // –°–æ–∑–¥–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —á–∞—Ç–∞
                if (!this.chatMessages[contactId]) {
                    this.chatMessages[contactId] = [
                        { 
                            text: `–ü—Ä–∏–≤–µ—Ç! –Ø ${friend.first_name}. –ù–∞—á–Ω–µ–º –æ–±—â–µ–Ω–∏–µ!`, 
                            isSent: false, 
                            timestamp: Date.now() - 1800000 
                        }
                    ];
                }
            });

            this.renderContacts();
        }

        checkExistingAuth() {
            const savedToken = localStorage.getItem('vk_access_token');
            const savedUser = localStorage.getItem('vk_user_data');
            
            if (savedToken && savedUser) {
                this.vkAccessToken = savedToken;
                this.userData = JSON.parse(savedUser);
                this.handleSuccessfulAuth();
            }
        }

        logout() {
            this.isVKAuthenticated = false;
            this.vkAccessToken = null;
            this.userData = null;
            this.vkFriends = [];
            
            localStorage.removeItem('vk_access_token');
            localStorage.removeItem('vk_user_data');
            
            this.userProfile.style.display = 'none';
            this.vkAuthContainer.style.display = 'block';
            this.authStatus.textContent = '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';
            this.userAvatar.innerHTML = '<i class="fas fa-user"></i>';
            
            // –£–¥–∞–ª—è–µ–º VK –∫–æ–Ω—Ç–∞–∫—Ç—ã
            Object.keys(this.chatData).forEach(key => {
                if (key.startsWith('vk_')) {
                    delete this.chatData[key];
                }
            });
            
            this.renderContacts();
            this.showNotification('–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞', 'info');
        }

        // –†–ï–ê–õ–¨–ù–´–ï –ó–í–û–ù–ö–ò –ß–ï–†–ï–ó VK
        async startCall() {
            if (!this.currentChat || !this.chatData[this.currentChat]?.canCall) {
                this.showNotification('–ó–≤–æ–Ω–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞', 'error');
                return;
            }

            if (!this.isVKAuthenticated) {
                this.showNotification('–î–ª—è —Å–æ–≤–µ—Ä—à–µ–Ω–∏—è –∑–≤–æ–Ω–∫–æ–≤ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ VK', 'error');
                return;
            }

            const chat = this.chatData[this.currentChat];
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–æ–∂–Ω–æ –ª–∏ –∑–≤–æ–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            const canCall = await this.checkUserCanCall(chat.vkId);
            if (!canCall) {
                this.showNotification(`–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–∑–≤–æ–Ω–∏—Ç—å ${chat.name}`, 'error');
                return;
            }

            this.showNotification(`–ò–Ω–∏—Ü–∏–∏—Ä—É–µ–º –∑–≤–æ–Ω–æ–∫ ${chat.name}...`, 'info');
            this.openVKCall(chat.vkId);
        }

        async checkUserCanCall(vkUserId) {
            if (!vkUserId || !this.vkAccessToken) return false;

            try {
                const response = await fetch(
                    `https://api.vk.com/method/users.get?` +
                    `user_ids=${vkUserId}&` +
                    `fields=can_call,online&` +
                    `access_token=${this.vkAccessToken}&` +
                    `v=5.199`
                );

                const data = await response.json();
                
                if (data.response && data.response[0]) {
                    const user = data.response[0];
                    return user.can_call === 1 && user.online === 1;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∑–≤–æ–Ω–∫–∞:', error);
            }
            
            return false;
        }

        openVKCall(vkUserId) {
            // Deeplink –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∑–≤–æ–Ω–∫–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ VK
            const appUrl = `vk://call/${vkUserId}`;
            
            // Web –≤–µ—Ä—Å–∏—è –∑–≤–æ–Ω–∫–∞
            const webUrl = `https://vk.com/call/${vkUserId}`;
            
            // –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–∫—Ä—ã—Ç—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ VK
            this.openAppOrRedirect(appUrl, webUrl);
        }

        openAppOrRedirect(appUrl, webUrl) {
            // –°–æ–∑–¥–∞–µ–º —Å–∫—Ä—ã—Ç—ã–π iframe –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = appUrl;
            document.body.appendChild(iframe);
            
            // –¢–∞–π–º–∞—É—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç–∫—Ä—ã–ª–æ—Å—å –ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            let appOpened = false;
            const startTime = Date.now();
            
            // –°–ª—É—à–∞–µ–º focus/blur –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            window.addEventListener('blur', () => {
                appOpened = true;
            });
            
            // –ß–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É –ø—Ä–æ–≤–µ—Ä—è–µ–º
            setTimeout(() => {
                document.body.removeChild(iframe);
                
                if (!appOpened) {
                    // –ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –æ—Ç–∫—Ä—ã–ª–æ—Å—å, –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≤–µ–±-–≤–µ—Ä—Å–∏—é
                    window.open(webUrl, '_blank');
                    this.showNotification('–û—Ç–∫—Ä—ã–≤–∞–µ–º –≤–µ–±-–≤–µ—Ä—Å–∏—é –∑–≤–æ–Ω–∫–∞...', 'info');
                } else {
                    this.showNotification('–û—Ç–∫—Ä—ã—Ç–æ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ VK', 'success');
                }
            }, 1000);
        }

        // –ò–º–∏—Ç–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ –∑–≤–æ–Ω–∫–∞ (–º–æ–∂–Ω–æ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–∞)
        setupCallScreen(chat) {
            this.resetCallScreenPosition();
            this.callContactName.textContent = chat.name;
            
            const callAvatarContent = chat.avatar.startsWith('url') ? 
                `<div style="width: 100%; height: 100%; border-radius: 50%; background-image: ${chat.avatar}; background-size: cover;"></div>` :
                `<i class="${chat.avatar}"></i>`;
            
            this.callAvatar.innerHTML = callAvatarContent;
            this.callScreen.classList.add('active');
            this.isCallMinimized = false;

            this.callSeconds = 0;
            this.callTimer.textContent = '00:00';
            this.resetCallControls();

            this.clearCallInterval();
            this.callInterval = setInterval(() => this.updateCallTimer(), 1000);
        }

        updateCallTimer() {
            const minutes = Math.floor(this.callSeconds / 60);
            const secs = this.callSeconds % 60;
            this.callTimer.textContent = `${minutes.toString().padStart(2, "0")}:${secs.toString().padStart(2, "0")}`;
            this.callSeconds++;
        }

        clearCallInterval() {
            if (this.callInterval) {
                clearInterval(this.callInterval);
                this.callInterval = null;
            }
        }

        // –û—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        handleSearch() {
            const query = this.searchField.value.trim().toLowerCase();
            this.searchResults.innerHTML = '';

            if (query.length === 0) {
                this.searchResults.classList.remove('active');
                return;
            }

            const results = Object.values(this.chatData).filter(contact => 
                contact.username && contact.username.toLowerCase().includes(query)
            );

            if (results.length > 0) {
                results.forEach(contact => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    resultItem.innerHTML = `
                        <div><strong>${contact.name}</strong></div>
                        <div class="username-tag">${contact.username}</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">${contact.status}</div>
                    `;
                    resultItem.addEventListener('click', () => {
                        this.switchChat(contact.id);
                        this.closeSearch();
                    });
                    this.searchResults.appendChild(resultItem);
                });
                this.searchResults.classList.add('active');
            } else {
                const noResults = document.createElement('div');
                noResults.className = 'search-result-item';
                noResults.textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
                noResults.style.color = 'var(--text-secondary)';
                this.searchResults.appendChild(noResults);
                this.searchResults.classList.add('active');
            }
        }

        autoResizeTextarea() {
            this.messageInput.style.height = 'auto';
            const newHeight = Math.min(this.messageInput.scrollHeight, 120);
            this.messageInput.style.height = newHeight + 'px';
            this.updateSendButtonState();
        }

        updateSendButtonState() {
            const hasText = this.messageInput.value.trim().length > 0;
            this.sendButton.disabled = !hasText;
        }

        sendMessage() {
            const text = this.messageInput.value.trim();
            if (!text || !this.currentChat) return;

            this.addMessage(text, true);
            this.messageInput.value = '';
            this.messageInput.style.height = 'auto';
            this.updateSendButtonState();

            // –ò–º–∏—Ç–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞
            if (this.currentChat !== 'favorites' && this.currentChat.startsWith('vk_')) {
                setTimeout(() => {
                    const responses = [
                        '–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?',
                        '–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!',
                        '–Ø –ø–æ–Ω—è–ª —Ç–µ–±—è',
                        '–û—Ç–ª–∏—á–Ω–∞—è –º—ã—Å–ª—å!',
                        '–°–æ–≥–ª–∞—Å–µ–Ω üëç',
                        '–†–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ'
                    ];
                    const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                    this.addMessage(randomResponse, false);
                }, 1000 + Math.random() * 2000);
            }
        }

        addMessage(text, isSent) {
            if (!this.chatMessages[this.currentChat]) {
                this.chatMessages[this.currentChat] = [];
            }

            const message = {
                text,
                isSent,
                timestamp: Date.now()
            };

            this.chatMessages[this.currentChat].push(message);
            this.renderMessages();
        }

        renderMessages() {
            if (!this.currentChat || !this.chatMessages[this.currentChat]) {
                return;
            }

            this.messagesContainer.innerHTML = '';
            const messages = this.chatMessages[this.currentChat];

            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.isSent ? 'sent' : 'received'}`;
                
                messageDiv.innerHTML = `
                    <div class="message-bubble">
                        ${this.escapeHtml(msg.text)}
                    </div>
                `;
                
                this.messagesContainer.appendChild(messageDiv);
            });

            setTimeout(() => {
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
            }, 0);
        }

        renderContacts() {
            this.contactsList.innerHTML = '';

            Object.values(this.chatData).forEach(contact => {
                const contactElement = document.createElement('div');
                contactElement.className = `contact ${this.currentChat === contact.id ? 'active' : ''}`;
                contactElement.setAttribute('data-chat', contact.id);
                
                const avatarContent = contact.avatar.startsWith('url') ? 
                    `<div style="width: 100%; height: 100%; border-radius: 50%; background-image: ${contact.avatar}; background-size: cover;"></div>` :
                    `<i class="${contact.avatar}"></i>`;
                
                contactElement.innerHTML = `
                    <div class="contact-avatar">
                        ${avatarContent}
                    </div>
                    <div class="contact-info">
                        <h3>${contact.name}</h3>
                        <p>${contact.status}</p>
                        ${contact.username ? `<small class="username-tag">${contact.username}</small>` : ''}
                    </div>
                `;

                contactElement.addEventListener('click', () => this.switchChat(contact.id));
                this.contactsList.appendChild(contactElement);
            });
        }

        switchChat(chatId) {
            if (chatId === this.currentChat) return;

            this.currentChat = chatId;
            const chat = this.chatData[chatId];

            if (!chat) {
                console.error(`–ß–∞—Ç ${chatId} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
                return;
            }

            this.currentChatName.textContent = chat.name;
            this.currentChatStatus.textContent = chat.status;
            
            const avatarContent = chat.avatar.startsWith('url') ? 
                `<div style="width: 100%; height: 100%; border-radius: 50%; background-image: ${chat.avatar}; background-size: cover;"></div>` :
                `<i class="${chat.avatar}"></i>`;
            
            this.currentChatAvatar.innerHTML = avatarContent;

            if (chat.canCall && this.isVKAuthenticated) {
                this.chatActions.classList.remove('hidden');
            } else {
                this.chatActions.classList.add('hidden');
            }

            this.renderMessages();
            this.renderContacts();

            if (window.innerWidth <= 768) {
                this.toggleSidebar(false);
            }
        }

        endCall() {
            this.callScreen.style.opacity = '0';
            this.callScreen.style.transform = 'scale(0.9)';

            setTimeout(() => {
                this.callScreen.classList.remove('active');
                this.callScreen.classList.remove('minimized');
                this.isCallMinimized = false;
                this.callScreen.style.opacity = '1';
                this.callScreen.style.transform = 'scale(1)';
                this.resetCallScreenPosition();
                this.minimizeCallBtn.innerHTML = '<i class="fas fa-compress"></i>';
                this.clearCallInterval();
                this.showNotification('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω', 'info');
            }, 300);
        }

        toggleCallMinimize() {
            this.isCallMinimized = !this.isCallMinimized;
            if (this.isCallMinimized) {
                this.resetCallScreenPosition();
                this.callScreen.classList.add('minimized');
            } else {
                this.resetCallScreenPosition();
                this.callScreen.classList.remove('minimized');
            }
            this.minimizeCallBtn.innerHTML = this.isCallMinimized 
                ? '<i class="fas fa-expand"></i>' 
                : '<i class="fas fa-compress"></i>';
        }

        toggleCallControl(btn, activeIcon, inactiveIcon) {
            btn.classList.toggle('active');
            btn.querySelector('i').className = btn.classList.contains('active') 
                ? activeIcon 
                : inactiveIcon;
            const action = btn.classList.contains('active') ? '–≤–∫–ª—é—á–µ–Ω–æ' : '–≤—ã–∫–ª—é—á–µ–Ω–æ';
            this.showNotification(`${btn.id.replace('call', '').replace('Btn', '')} ${action}`, 'info');
        }

        setupCallDragging() {
            this.callScreen.addEventListener('mousedown', (e) => this.startDrag(e));
            this.callScreen.addEventListener('touchstart', (e) => this.startDragTouch(e));
            document.addEventListener('mousemove', (e) => this.drag(e));
            document.addEventListener('touchmove', (e) => this.dragTouch(e));
            document.addEventListener('mouseup', () => this.stopDrag());
            document.addEventListener('touchend', () => this.stopDrag());
        }

        startDrag(e) {
            if (!this.isCallMinimized) return;
            this.isDragging = true;
            const rect = this.callScreen.getBoundingClientRect();
            this.dragOffset.x = e.clientX - rect.left;
            this.dragOffset.y = e.clientY - rect.top;
            this.callScreen.style.transition = 'none';
            this.callScreen.style.cursor = 'grabbing';
        }

        startDragTouch(e) {
            if (!this.isCallMinimized) return;
            this.isDragging = true;
            const touch = e.touches[0];
            const rect = this.callScreen.getBoundingClientRect();
            this.dragOffset.x = touch.clientX - rect.left;
            this.dragOffset.y = touch.clientY - rect.top;
            this.callScreen.style.transition = 'none';
        }

        drag(e) {
            if (!this.isDragging || !this.isCallMinimized) return;
            const x = e.clientX - this.dragOffset.x;
            const y = e.clientY - this.dragOffset.y;
            const maxX = window.innerWidth - this.callScreen.offsetWidth - 10;
            const maxY = window.innerHeight - this.callScreen.offsetHeight - 10;
            this.callScreen.style.left = Math.max(10, Math.min(x, maxX)) + 'px';
            this.callScreen.style.top = Math.max(10, Math.min(y, maxY)) + 'px';
            this.callScreen.style.right = 'auto';
            this.callScreen.style.bottom = 'auto';
        }

        dragTouch(e) {
            if (!this.isDragging || !this.isCallMinimized) return;
            const touch = e.touches[0];
            const x = touch.clientX - this.dragOffset.x;
            const y = touch.clientY - this.dragOffset.y;
            const maxX = window.innerWidth - this.callScreen.offsetWidth - 10;
            const maxY = window.innerHeight - this.callScreen.offsetHeight - 10;
            this.callScreen.style.left = Math.max(10, Math.min(x, maxX)) + 'px';
            this.callScreen.style.top = Math.max(10, Math.min(y, maxY)) + 'px';
            this.callScreen.style.right = 'auto';
            this.callScreen.style.bottom = 'auto';
        }

        stopDrag() {
            if (!this.isDragging) return;
            this.isDragging = false;
            this.callScreen.style.transition = 'all 0.3s ease';
            this.callScreen.style.cursor = 'move';
        }

        toggleSidebar(show) {
            if (show) {
                this.sidebar.classList.add('active');
                this.sidebarOverlay.classList.add('active');
            } else {
                this.sidebar.classList.remove('active');
                this.sidebarOverlay.classList.remove('active');
            }
        }

        toggleSlideMenu(show) {
            if (show) {
                this.slideMenu.classList.add('active');
                this.chatOverlay.classList.add('active');
            } else {
                this.slideMenu.classList.remove('active');
                this.chatOverlay.classList.remove('active');
            }
        }

        openSearch() {
            this.searchContainer.classList.add('active');
            setTimeout(() => {
                this.searchField.focus();
            }, 300);
        }

        closeSearch() {
            this.searchContainer.classList.remove('active');
            this.searchField.value = '';
            this.searchResults.classList.remove('active');
            this.searchField.blur();
        }

        showProfile() {
            if (!this.isVKAuthenticated) {
                this.showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å —á–µ—Ä–µ–∑ VK –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–æ—Ñ–∏–ª—è', 'error');
                return;
            }
            this.showNotification(`–ü—Ä–æ—Ñ–∏–ª—å VK:\n${this.userData.firstName} ${this.userData.lastName}\n${this.userData.username}`, 'info');
        }

        showNotification(message, type = 'info') {
            this.notification.textContent = message;
            this.notification.className = 'notification show';
            if (type === 'error') {
                this.notification.style.borderLeft = '4px solid #e74c3c';
            } else if (type === 'success') {
                this.notification.style.borderLeft = '4px solid #2ecc71';
            } else {
                this.notification.style.borderLeft = '4px solid #3498db';
            }
            setTimeout(() => {
                this.notification.classList.remove('show');
            }, 3000);
        }

        handleWindowResize() {
            if (this.isCallMinimized) {
                const rect = this.callScreen.getBoundingClientRect();
                const maxX = window.innerWidth - this.callScreen.offsetWidth - 10;
                const maxY = window.innerHeight - this.callScreen.offsetHeight - 10;
                if (rect.left > maxX || rect.top > maxY) {
                    this.callScreen.style.left = Math.max(10, Math.min(rect.left, maxX)) + 'px';
                    this.callScreen.style.top = Math.max(10, Math.min(rect.top, maxY)) + 'px';
                }
            }
            if (window.innerWidth > 768) {
                this.toggleSidebar(false);
            }
        }

        cleanup() {
            this.clearCallInterval();
            if (this.isVKAuthenticated && this.vkAccessToken && this.userData) {
                localStorage.setItem('vk_access_token', this.vkAccessToken);
                localStorage.setItem('vk_user_data', JSON.stringify(this.userData));
            }
        }

        resetCallControls() {
            this.callMuteBtn.classList.remove('active');
            this.callMuteBtn.querySelector('i').className = 'fas fa-microphone';
            this.callSpeakerBtn.classList.remove('active');
            this.callSpeakerBtn.querySelector('i').className = 'fas fa-volume-up';
        }

        resetCallScreenPosition() {
            this.callScreen.style.left = '0';
            this.callScreen.style.top = '0';
            this.callScreen.style.right = 'auto';
            this.callScreen.style.bottom = 'auto';
            this.callScreen.style.transform = 'none';
        }

        escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        new FlimeMessenger();
    });
</script>
