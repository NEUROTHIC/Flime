<script>
    class FlimeMessenger {
        constructor() {
            // –í–∞—à —Ä–µ–∞–ª—å–Ω—ã–π Google Client ID
            this.GOOGLE_CLIENT_ID = '760662462316-asoimf8g3nsbbq32oqc4359jeqhunc80.apps.googleusercontent.com';
            this.init();
        }

        init() {
            this.initializeElements();
            this.setupEventListeners();
            this.initializeApp();
            this.loadGoogleAuthSDK();
        }

        initializeElements() {
            // –í—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã DOM
            this.messagesContainer = document.getElementById('messagesContainer');
            this.messageInput = document.getElementById('messageInput');
            this.sendButton = document.getElementById('sendButton');
            this.sidebar = document.getElementById('sidebar');
            this.openSidebar = document.getElementById('openSidebar');
            this.closeSidebar = document.getElementById('closeSidebar');
            this.sidebarOverlay = document.getElementById('sidebarOverlay');
            this.menuToggle = document.getElementById('menuToggle');
            this.slideMenu = document.getElementById('slideMenu');
            this.closeMenu = document.getElementById('closeMenu');
            this.chatOverlay = document.getElementById('chatOverlay');
            this.searchToggle = document.getElementById('searchToggle');
            this.searchContainer = document.getElementById('searchContainer');
            this.searchField = document.getElementById('searchField');
            this.searchClose = document.getElementById('searchClose');
            this.searchResults = document.getElementById('searchResults');
            this.callScreen = document.getElementById('callScreen');
            this.startCallBtn = document.getElementById('startCallBtn');
            this.chatActions = document.getElementById('chatActions');
            this.minimizeCallBtn = document.getElementById('minimizeCall');
            this.endCallBtn = document.getElementById('endCallBtn');
            this.callMuteBtn = document.getElementById('callMuteBtn');
            this.callSpeakerBtn = document.getElementById('callSpeakerBtn');
            this.callTimer = document.getElementById('callTimer');
            this.callContactName = document.getElementById('callContactName');
            this.callAvatar = document.getElementById('callAvatar');
            this.currentChatName = document.getElementById('currentChatName');
            this.currentChatStatus = document.getElementById('currentChatStatus');
            this.currentChatAvatar = document.getElementById('currentChatAvatar');
            this.chatArea = document.getElementById('chatArea');
            this.contactsList = document.getElementById('contactsList');
            this.vkAuthBtn = document.getElementById('vkAuthBtn');
            this.authStatus = document.getElementById('authStatus');
            this.userProfile = document.getElementById('userProfile');
            this.userName = document.getElementById('userName');
            this.userUsername = document.getElementById('userUsername');
            this.userAvatar = document.getElementById('userAvatar');
            this.logoutBtn = document.getElementById('logoutBtn');
            this.vkAuthContainer = document.getElementById('vkAuthContainer');
            this.profileMenuItem = document.getElementById('profileMenuItem');
            this.notification = document.getElementById('notification');

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            this.vkAuthBtn.innerHTML = '<i class="fab fa-google"></i> –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google';
            this.vkAuthBtn.id = 'googleAuthBtn';

            this.currentChat = null;
            this.callSeconds = 0;
            this.callInterval = null;
            this.isCallMinimized = false;
            this.isDragging = false;
            this.dragOffset = { x: 0, y: 0 };
            this.isAuthenticated = false;
            this.userData = null;
            this.googleAuth = null;
            this.allUsers = new Set(); // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —é–∑–µ—Ä–Ω–µ–π–º–æ–≤
        }

        // –î–∞–Ω–Ω—ã–µ —á–∞—Ç–æ–≤
        chatData = {
            'favorites': {
                id: 'favorites',
                name: '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ',
                status: '–ü–æ—Å–ª–µ–¥–Ω–∏–µ –≤–∞–∂–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è',
                avatar: 'fas fa-star',
                canCall: false,
                username: null,
                email: null
            },
            'techsupport': {
                id: 'techsupport',
                name: '–¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞',
                status: '–û–Ω–ª–∞–π–Ω',
                avatar: 'fas fa-headset',
                canCall: true,
                username: '@support',
                email: 'support@flime.com'
            },
            'developer': {
                id: 'developer',
                name: '–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫',
                status: '–ë—ã–ª –Ω–µ–¥–∞–≤–Ω–æ',
                avatar: 'fas fa-code',
                canCall: true,
                username: '@dev',
                email: 'dev@flime.com'
            }
        };

        chatMessages = {
            'favorites': [
                { text: '–ü—Ä–∏–≤–µ—Ç! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Flime Messenger!', isSent: false, timestamp: Date.now() - 3600000 },
                { text: '–°–ø–∞—Å–∏–±–æ! –ó–¥–µ—Å—å –æ—á–µ–Ω—å –∫—Ä—É—Ç–æ–π –¥–∏–∑–∞–π–Ω!', isSent: true, timestamp: Date.now() - 3500000 },
                { text: '–ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º', isSent: false, timestamp: Date.now() - 3400000 }
            ],
            'techsupport': [
                { text: '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?', isSent: false, timestamp: Date.now() - 7200000 },
                { text: '–£ –º–µ–Ω—è –≤–æ–ø—Ä–æ—Å –ø–æ —Ä–∞–±–æ—Ç–µ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞', isSent: true, timestamp: Date.now() - 7100000 },
                { text: '–ö–æ–Ω–µ—á–Ω–æ! –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ –ø—Ä–æ–±–ª–µ–º–µ', isSent: false, timestamp: Date.now() - 7000000 }
            ],
            'developer': [
                { text: '–ü—Ä–∏–≤–µ—Ç! –Ø —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ —ç—Ç–æ–≥–æ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞', isSent: false, timestamp: Date.now() - 1800000 },
                { text: '–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –û—á–µ–Ω—å –Ω—Ä–∞–≤–∏—Ç—Å—è –¥–∏–∑–∞–π–Ω', isSent: true, timestamp: Date.now() - 1700000 },
                { text: '–°–ø–∞—Å–∏–±–æ! –ë—É–¥—É —Ä–∞–¥ —É—Å–ª—ã—à–∞—Ç—å –≤–∞—à–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è', isSent: false, timestamp: Date.now() - 1600000 }
            ]
        };

        // –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–ª—É—á–∞–π–Ω—ã—Ö —é–∑–µ—Ä–Ω–µ–π–º–æ–≤ (7 —Å–∏–º–≤–æ–ª–æ–≤: –∞–Ω–≥–ª + —Ü–∏—Ñ—Ä—ã)
        generateUsername() {
            const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
            let username = '';
            
            do {
                username = '';
                for (let i = 0; i < 7; i++) {
                    username += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                username = '@' + username;
            } while (this.allUsers.has(username)); // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å
            
            this.allUsers.add(username);
            return username;
        }

        loadGoogleAuthSDK() {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º Google Auth SDK
            const script = document.createElement('script');
            script.src = 'https://accounts.google.com/gsi/client';
            script.async = true;
            script.defer = true;
            script.onload = () => this.initializeGoogleAuth();
            document.head.appendChild(script);
        }

        initializeGoogleAuth() {
            try {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Google Auth
                this.googleAuth = google.accounts.oauth2.initTokenClient({
                    client_id: this.GOOGLE_CLIENT_ID,
                    scope: 'https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email',
                    callback: (response) => this.handleGoogleAuth(response),
                });
            } catch (error) {
                console.log('Google Auth SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–º–æ-—Ä–µ–∂–∏–º');
                this.showNotification('–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–µ–º–æ-—Ä–µ–∂–∏–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', 'info');
            }
        }

        setupEventListeners() {
            this.messageInput.addEventListener('input', () => this.autoResizeTextarea());
            this.sendButton.addEventListener('click', () => this.sendMessage());
            this.messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.sendMessage();
                }
            });

            this.openSidebar.addEventListener('click', () => this.toggleSidebar(true));
            this.closeSidebar.addEventListener('click', () => this.toggleSidebar(false));
            this.sidebarOverlay.addEventListener('click', () => this.toggleSidebar(false));
            this.menuToggle.addEventListener('click', () => this.toggleSlideMenu(true));
            this.closeMenu.addEventListener('click', () => this.toggleSlideMenu(false));
            this.chatOverlay.addEventListener('click', () => this.toggleSlideMenu(false));

            this.searchToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                this.openSearch();
            });
            this.searchClose.addEventListener('click', (e) => {
                e.stopPropagation();
                this.closeSearch();
            });
            this.searchField.addEventListener('input', () => this.handleSearch());
            this.searchField.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') this.closeSearch();
            });

            this.startCallBtn.addEventListener('click', () => this.startCall());
            this.minimizeCallBtn.addEventListener('click', () => this.toggleCallMinimize());
            this.endCallBtn.addEventListener('click', () => this.endCall());
            this.callMuteBtn.addEventListener('click', () => this.toggleCallControl(this.callMuteBtn, 'fas fa-microphone-slash', 'fas fa-microphone'));
            this.callSpeakerBtn.addEventListener('click', () => this.toggleCallControl(this.callSpeakerBtn, 'fas fa-volume-mute', 'fas fa-volume-up'));

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è Google Auth
            const googleAuthBtn = document.getElementById('googleAuthBtn');
            googleAuthBtn.addEventListener('click', () => this.initGoogleAuth());
            this.logoutBtn.addEventListener('click', () => this.logout());
            this.profileMenuItem.addEventListener('click', () => this.showProfile());

            this.setupCallDragging();

            document.addEventListener('click', (e) => {
                if (this.searchContainer.classList.contains('active') && 
                    !this.searchContainer.contains(e.target) && 
                    e.target !== this.searchToggle) {
                    this.closeSearch();
                }
            });

            window.addEventListener('resize', () => this.handleWindowResize());
            window.addEventListener('beforeunload', () => this.cleanup());

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —é–∑–µ—Ä–Ω–µ–π–º—ã
            this.initializeExistingUsernames();
        }

        initializeExistingUsernames() {
            // –î–æ–±–∞–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —é–∑–µ—Ä–Ω–µ–π–º—ã –≤ Set –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏
            Object.values(this.chatData).forEach(contact => {
                if (contact.username) {
                    this.allUsers.add(contact.username);
                }
            });
        }

        initializeApp() {
            this.renderContacts();
            this.updateSendButtonState();
            this.checkExistingAuth();
        }

        // GOOGLE –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø
        initGoogleAuth() {
            if (this.googleAuth) {
                this.googleAuth.requestAccessToken();
            } else {
                // –î–µ–º–æ-—Ä–µ–∂–∏–º –µ—Å–ª–∏ Google Auth –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω
                this.demoAuth();
            }
        }

        async handleGoogleAuth(response) {
            if (response.access_token) {
                this.showNotification('–£—Å–ø–µ—à–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è! –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ...', 'success');
                await this.fetchGoogleUserData(response.access_token);
            } else {
                this.showNotification('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', 'error');
            }
        }

        async fetchGoogleUserData(accessToken) {
            try {
                const profileResponse = await fetch('https://www.googleapis.com/oauth2/v1/userinfo?alt=json', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                const profileData = await profileResponse.json();
                
                this.userData = {
                    id: profileData.id,
                    firstName: profileData.given_name || 'User',
                    lastName: profileData.family_name || '',
                    fullName: profileData.name || 'Google User',
                    email: profileData.email,
                    photo: profileData.picture,
                    username: this.generateUsername() // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —é–∑–µ—Ä–Ω–µ–π–º
                };

                this.handleSuccessfulAuth(accessToken);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö Google:', error);
                // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–º–æ-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
                this.demoAuth();
            }
        }

        // –î–µ–º–æ-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –µ—Å–ª–∏ Google –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
        demoAuth() {
            this.userData = {
                id: 'demo-' + Date.now(),
                firstName: 'Demo',
                lastName: 'User',
                fullName: 'Demo User',
                email: 'demo@flime.com',
                username: this.generateUsername()
            };
            
            this.handleSuccessfulAuth('demo-token');
            this.showNotification('–î–µ–º–æ-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!', 'success');
        }

        handleSuccessfulAuth(accessToken) {
            this.isAuthenticated = true;
            this.vkAuthContainer.style.display = 'none';
            this.userProfile.style.display = 'flex';
            this.userName.textContent = this.userData.fullName;
            this.userUsername.textContent = this.userData.username;
            
            if (this.userData.photo) {
                this.userAvatar.innerHTML = `<img src="${this.userData.photo}" style="width: 100%; height: 100%; border-radius: 50%;" alt="Avatar">`;
            } else {
                this.userAvatar.innerHTML = '<i class="fas fa-user"></i>';
            }

            this.authStatus.textContent = `–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∫–∞–∫ ${this.userData.username}`;
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            this.addRandomUsers();
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
            localStorage.setItem('google_access_token', accessToken);
            localStorage.setItem('user_data', JSON.stringify(this.userData));
        }

        addRandomUsers() {
            // –î–æ–±–∞–≤–ª—è–µ–º 5 —Å–ª—É—á–∞–π–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            const randomAvatars = ['fas fa-user-friends', 'fas fa-user-tie', 'fas fa-user-graduate', 'fas fa-user-md', 'fas fa-user-ninja'];
            const statuses = ['–í —Å–µ—Ç–∏', '–ë—ã–ª –Ω–µ–¥–∞–≤–Ω–æ', '–ë—ã–ª 2 —á. –Ω–∞–∑–∞–¥', '–ë—ã–ª 5 —á. –Ω–∞–∑–∞–¥', '–ù–µ –≤ —Å–µ—Ç–∏'];
            
            for (let i = 0; i < 5; i++) {
                const userId = 'user_' + Date.now() + '_' + i;
                const username = this.generateUsername();
                
                this.chatData[userId] = {
                    id: userId,
                    name: `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${i + 1}`,
                    status: statuses[Math.floor(Math.random() * statuses.length)],
                    avatar: randomAvatars[Math.floor(Math.random() * randomAvatars.length)],
                    canCall: true,
                    username: username,
                    email: `user${i + 1}@example.com`
                };

                if (!this.chatMessages[userId]) {
                    this.chatMessages[userId] = [
                        { 
                            text: `–ü—Ä–∏–≤–µ—Ç! –Ø –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Flime!`, 
                            isSent: false, 
                            timestamp: Date.now() - Math.random() * 86400000 
                        }
                    ];
                }
            }

            this.renderContacts();
        }

        checkExistingAuth() {
            const savedToken = localStorage.getItem('google_access_token');
            const savedUser = localStorage.getItem('user_data');
            
            if (savedToken && savedUser) {
                this.userData = JSON.parse(savedUser);
                this.isAuthenticated = true;
                this.vkAuthContainer.style.display = 'none';
                this.userProfile.style.display = 'flex';
                this.userName.textContent = this.userData.fullName;
                this.userUsername.textContent = this.userData.username;
                
                if (this.userData.photo) {
                    this.userAvatar.innerHTML = `<img src="${this.userData.photo}" style="width: 100%; height: 100%; border-radius: 50%;" alt="Avatar">`;
                }

                this.authStatus.textContent = `–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∫–∞–∫ ${this.userData.username}`;
                this.addRandomUsers();
            }
        }

        logout() {
            this.isAuthenticated = false;
            this.userData = null;
            
            // –í—ã—Ö–æ–¥ –∏–∑ Google
            if (this.googleAuth && localStorage.getItem('google_access_token') !== 'demo-token') {
                google.accounts.oauth2.revoke(localStorage.getItem('google_access_token'));
            }
            
            localStorage.removeItem('google_access_token');
            localStorage.removeItem('user_data');
            
            this.userProfile.style.display = 'none';
            this.vkAuthContainer.style.display = 'block';
            this.authStatus.textContent = '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';
            this.userAvatar.innerHTML = '<i class="fas fa-user"></i>';
            
            // –£–¥–∞–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            Object.keys(this.chatData).forEach(key => {
                if (key.startsWith('user_')) {
                    delete this.chatData[key];
                }
            });
            
            this.renderContacts();
            this.showNotification('–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞', 'info');
        }

        // GOOGLE MEET –ó–í–û–ù–ö–ò
        startCall() {
            if (!this.currentChat || !this.chatData[this.currentChat]?.canCall) {
                this.showNotification('–ó–≤–æ–Ω–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞', 'error');
                return;
            }

            if (!this.isAuthenticated) {
                this.showNotification('–î–ª—è —Å–æ–≤–µ—Ä—à–µ–Ω–∏—è –∑–≤–æ–Ω–∫–æ–≤ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è', 'error');
                return;
            }

            const chat = this.chatData[this.currentChat];
            this.showNotification(`–°–æ–∑–¥–∞–µ–º –∑–≤–æ–Ω–æ–∫ —Å ${chat.name}...`, 'info');
            
            // –°–æ–∑–¥–∞–µ–º Google Meet –∑–≤–æ–Ω–æ–∫
            this.createGoogleMeetCall(chat);
        }

        createGoogleMeetCall(chat) {
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –¥–ª—è Meet
            const meetCode = this.generateMeetCode();
            const meetUrl = `https://meet.google.com/${meetCode}`;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –∑–≤–æ–Ω–∫–∞
            this.setupCallScreen(chat);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å—Å—ã–ª–∫–æ–π –≤ —á–∞—Ç
            this.addMessage(`üîó –°—Å—ã–ª–∫–∞ –¥–ª—è –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∞: ${meetUrl}`, false);
            
            this.showNotification(`–ó–≤–æ–Ω–æ–∫ —Å–æ–∑–¥–∞–Ω! –°—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ —á–∞—Ç`, 'success');
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º Meet —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                window.open(meetUrl, '_blank', 'width=1000,height=700');
            }, 2000);
        }

        generateMeetCode() {
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –∫–æ–¥ –¥–ª—è Meet (12 —Å–∏–º–≤–æ–ª–æ–≤ + -flm)
            const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < 12; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result + '-flm';
        }

        setupCallScreen(chat) {
            this.resetCallScreenPosition();
            this.callContactName.textContent = chat.name;
            
            const callAvatarContent = chat.avatar.startsWith('url') ? 
                `<div style="width: 100%; height: 100%; border-radius: 50%; background-image: ${chat.avatar}; background-size: cover;"></div>` :
                `<i class="${chat.avatar}"></i>`;
            
            this.callAvatar.innerHTML = callAvatarContent;
            this.callScreen.classList.add('active');
            this.isCallMinimized = false;

            this.callSeconds = 0;
            this.callTimer.textContent = '00:00';
            this.resetCallControls();

            this.clearCallInterval();
            this.callInterval = setInterval(() => this.updateCallTimer(), 1000);
        }

        // –ü–û–ò–°–ö –ü–û –Æ–ó–ï–†–ù–ï–ô–ú–£
        handleSearch() {
            const query = this.searchField.value.trim().toLowerCase();
            this.searchResults.innerHTML = '';

            if (query.length === 0) {
                this.searchResults.classList.remove('active');
                return;
            }

            // –ò—â–µ–º –ø–æ —é–∑–µ—Ä–Ω–µ–π–º—É, –∏–º–µ–Ω–∏ –∏–ª–∏ email
            const results = Object.values(this.chatData).filter(contact => 
                (contact.username && contact.username.toLowerCase().includes(query)) ||
                (contact.name && contact.name.toLowerCase().includes(query)) ||
                (contact.email && contact.email.toLowerCase().includes(query))
            );

            if (results.length > 0) {
                results.forEach(contact => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    let highlight = '';
                    
                    if (contact.username && contact.username.toLowerCase().includes(query)) {
                        const startIndex = contact.username.toLowerCase().indexOf(query);
                        highlight = contact.username.substring(0, startIndex) + 
                                  '<mark>' + contact.username.substring(startIndex, startIndex + query.length) + '</mark>' +
                                  contact.username.substring(startIndex + query.length);
                    } else {
                        highlight = contact.username;
                    }
                    
                    resultItem.innerHTML = `
                        <div><strong>${contact.name}</strong></div>
                        <div class="username-tag">${highlight}</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">${contact.status}</div>
                    `;
                    resultItem.addEventListener('click', () => {
                        this.switchChat(contact.id);
                        this.closeSearch();
                    });
                    this.searchResults.appendChild(resultItem);
                });
                this.searchResults.classList.add('active');
            } else {
                const noResults = document.createElement('div');
                noResults.className = 'search-result-item';
                noResults.textContent = '–ö–æ–Ω—Ç–∞–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
                noResults.style.color = 'var(--text-secondary)';
                this.searchResults.appendChild(noResults);
                this.searchResults.classList.add('active');
            }
        }

        // –û—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        autoResizeTextarea() {
            this.messageInput.style.height = 'auto';
            const newHeight = Math.min(this.messageInput.scrollHeight, 120);
            this.messageInput.style.height = newHeight + 'px';
            this.updateSendButtonState();
        }

        updateSendButtonState() {
            const hasText = this.messageInput.value.trim().length > 0;
            this.sendButton.disabled = !hasText;
        }

        sendMessage() {
            const text = this.messageInput.value.trim();
            if (!text || !this.currentChat) return;

            this.addMessage(text, true);
            this.messageInput.value = '';
            this.messageInput.style.height = 'auto';
            this.updateSendButtonState();

            // –ò–º–∏—Ç–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞
            if (this.currentChat !== 'favorites') {
                setTimeout(() => {
                    const responses = [
                        '–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?',
                        '–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!',
                        '–Ø –ø–æ–Ω—è–ª —Ç–µ–±—è',
                        '–û—Ç–ª–∏—á–Ω–∞—è –º—ã—Å–ª—å!',
                        '–°–æ–≥–ª–∞—Å–µ–Ω üëç',
                        '–†–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ',
                        '–°–ø–∞—Å–∏–±–æ –∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ!',
                        '–û—á–µ–Ω—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ!'
                    ];
                    const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                    this.addMessage(randomResponse, false);
                }, 1000 + Math.random() * 2000);
            }
        }

        addMessage(text, isSent) {
            if (!this.chatMessages[this.currentChat]) {
                this.chatMessages[this.currentChat] = [];
            }

            const message = {
                text,
                isSent,
                timestamp: Date.now()
            };

            this.chatMessages[this.currentChat].push(message);
            this.renderMessages();
        }

        renderMessages() {
            if (!this.currentChat || !this.chatMessages[this.currentChat]) {
                return;
            }

            this.messagesContainer.innerHTML = '';
            const messages = this.chatMessages[this.currentChat];

            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.isSent ? 'sent' : 'received'}`;
                
                messageDiv.innerHTML = `
                    <div class="message-bubble">
                        ${this.escapeHtml(msg.text)}
                    </div>
                `;
                
                this.messagesContainer.appendChild(messageDiv);
            });

            setTimeout(() => {
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
            }, 0);
        }

        renderContacts() {
            this.contactsList.innerHTML = '';

            Object.values(this.chatData).forEach(contact => {
                const contactElement = document.createElement('div');
                contactElement.className = `contact ${this.currentChat === contact.id ? 'active' : ''}`;
                contactElement.setAttribute('data-chat', contact.id);
                
                const avatarContent = contact.avatar.startsWith('url') ? 
                    `<div style="width: 100%; height: 100%; border-radius: 50%; background-image: ${contact.avatar}; background-size: cover;"></div>` :
                    `<i class="${contact.avatar}"></i>`;
                
                contactElement.innerHTML = `
                    <div class="contact-avatar">
                        ${avatarContent}
                    </div>
                    <div class="contact-info">
                        <h3>${contact.name}</h3>
                        <p>${contact.status}</p>
                        ${contact.username ? `<small class="username-tag">${contact.username}</small>` : ''}
                    </div>
                `;

                contactElement.addEventListener('click', () => this.switchChat(contact.id));
                this.contactsList.appendChild(contactElement);
            });
        }

        switchChat(chatId) {
            if (chatId === this.currentChat) return;

            this.currentChat = chatId;
            const chat = this.chatData[chatId];

            if (!chat) {
                console.error(`–ß–∞—Ç ${chatId} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
                return;
            }

            this.currentChatName.textContent = chat.name;
            this.currentChatStatus.textContent = chat.status;
            
            const avatarContent = chat.avatar.startsWith('url') ? 
                `<div style="width: 100%; height: 100%; border-radius: 50%; background-image: ${chat.avatar}; background-size: cover;"></div>` :
                `<i class="${chat.avatar}"></i>`;
            
            this.currentChatAvatar.innerHTML = avatarContent;

            if (chat.canCall && this.isAuthenticated) {
                this.chatActions.classList.remove('hidden');
            } else {
                this.chatActions.classList.add('hidden');
            }

            this.renderMessages();
            this.renderContacts();

            if (window.innerWidth <= 768) {
                this.toggleSidebar(false);
            }
        }

        updateCallTimer() {
            const minutes = Math.floor(this.callSeconds / 60);
            const secs = this.callSeconds % 60;
            this.callTimer.textContent = `${minutes.toString().padStart(2, "0")}:${secs.toString().padStart(2, "0")}`;
            this.callSeconds++;
        }

        clearCallInterval() {
            if (this.callInterval) {
                clearInterval(this.callInterval);
                this.callInterval = null;
            }
        }

        endCall() {
            this.callScreen.style.opacity = '0';
            this.callScreen.style.transform = 'scale(0.9)';

            setTimeout(() => {
                this.callScreen.classList.remove('active');
                this.callScreen.classList.remove('minimized');
                this.isCallMinimized = false;
                this.callScreen.style.opacity = '1';
                this.callScreen.style.transform = 'scale(1)';
                this.resetCallScreenPosition();
                this.minimizeCallBtn.innerHTML = '<i class="fas fa-compress"></i>';
                this.clearCallInterval();
                this.showNotification('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω', 'info');
            }, 300);
        }

        toggleCallMinimize() {
            this.isCallMinimized = !this.isCallMinimized;
            if (this.isCallMinimized) {
                this.resetCallScreenPosition();
                this.callScreen.classList.add('minimized');
            } else {
                this.resetCallScreenPosition();
                this.callScreen.classList.remove('minimized');
            }
            this.minimizeCallBtn.innerHTML = this.isCallMinimized 
                ? '<i class="fas fa-expand"></i>' 
                : '<i class="fas fa-compress"></i>';
        }

        toggleCallControl(btn, activeIcon, inactiveIcon) {
            btn.classList.toggle('active');
            btn.querySelector('i').className = btn.classList.contains('active') 
                ? activeIcon 
                : inactiveIcon;
            const action = btn.classList.contains('active') ? '–≤–∫–ª—é—á–µ–Ω–æ' : '–≤—ã–∫–ª—é—á–µ–Ω–æ';
            this.showNotification(`${btn.id.replace('call', '').replace('Btn', '')} ${action}`, 'info');
        }

        setupCallDragging() {
            this.callScreen.addEventListener('mousedown', (e) => this.startDrag(e));
            this.callScreen.addEventListener('touchstart', (e) => this.startDragTouch(e));
            document.addEventListener('mousemove', (e) => this.drag(e));
            document.addEventListener('touchmove', (e) => this.dragTouch(e));
            document.addEventListener('mouseup', () => this.stopDrag());
            document.addEventListener('touchend', () => this.stopDrag());
        }

        startDrag(e) {
            if (!this.isCallMinimized) return;
            this.isDragging = true;
            const rect = this.callScreen.getBoundingClientRect();
            this.dragOffset.x = e.clientX - rect.left;
            this.dragOffset.y = e.clientY - rect.top;
            this.callScreen.style.transition = 'none';
            this.callScreen.style.cursor = 'grabbing';
        }

        startDragTouch(e) {
            if (!this.isCallMinimized) return;
            this.isDragging = true;
            const touch = e.touches[0];
            const rect = this.callScreen.getBoundingClientRect();
            this.dragOffset.x = touch.clientX - rect.left;
            this.dragOffset.y = touch.clientY - rect.top;
            this.callScreen.style.transition = 'none';
        }

        drag(e) {
            if (!this.isDragging || !this.isCallMinimized) return;
            const x = e.clientX - this.dragOffset.x;
            const y = e.clientY - this.dragOffset.y;
            const maxX = window.innerWidth - this.callScreen.offsetWidth - 10;
            const maxY = window.innerHeight - this.callScreen.offsetHeight - 10;
            this.callScreen.style.left = Math.max(10, Math.min(x, maxX)) + 'px';
            this.callScreen.style.top = Math.max(10, Math.min(y, maxY)) + 'px';
            this.callScreen.style.right = 'auto';
            this.callScreen.style.bottom = 'auto';
        }

        dragTouch(e) {
            if (!this.isDragging || !this.isCallMinimized) return;
            const touch = e.touches[0];
            const x = touch.clientX - this.dragOffset.x;
            const y = touch.clientY - this.dragOffset.y;
            const maxX = window.innerWidth - this.callScreen.offsetWidth - 10;
            const maxY = window.innerHeight - this.callScreen.offsetHeight - 10;
            this.callScreen.style.left = Math.max(10, Math.min(x, maxX)) + 'px';
            this.callScreen.style.top = Math.max(10, Math.min(y, maxY)) + 'px';
            this.callScreen.style.right = 'auto';
            this.callScreen.style.bottom = 'auto';
        }

        stopDrag() {
            if (!this.isDragging) return;
            this.isDragging = false;
            this.callScreen.style.transition = 'all 0.3s ease';
            this.callScreen.style.cursor = 'move';
        }

        toggleSidebar(show) {
            if (show) {
                this.sidebar.classList.add('active');
                this.sidebarOverlay.classList.add('active');
            } else {
                this.sidebar.classList.remove('active');
                this.sidebarOverlay.classList.remove('active');
            }
        }

        toggleSlideMenu(show) {
            if (show) {
                this.slideMenu.classList.add('active');
                this.chatOverlay.classList.add('active');
            } else {
                this.slideMenu.classList.remove('active');
                this.chatOverlay.classList.remove('active');
            }
        }

        openSearch() {
            this.searchContainer.classList.add('active');
            setTimeout(() => {
                this.searchField.focus();
            }, 300);
        }

        closeSearch() {
            this.searchContainer.classList.remove('active');
            this.searchField.value = '';
            this.searchResults.classList.remove('active');
            this.searchField.blur();
        }

        showProfile() {
            if (!this.isAuthenticated) {
                this.showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–æ—Ñ–∏–ª—è', 'error');
                return;
            }
            this.showNotification(`–ü—Ä–æ—Ñ–∏–ª—å:\n${this.userData.fullName}\n${this.userData.email}\n${this.userData.username}`, 'info');
        }

        showNotification(message, type = 'info') {
            this.notification.textContent = message;
            this.notification.className = 'notification show';
            if (type === 'error') {
                this.notification.style.borderLeft = '4px solid #e74c3c';
            } else if (type === 'success') {
                this.notification.style.borderLeft = '4px solid #2ecc71';
            } else {
                this.notification.style.borderLeft = '4px solid #3498db';
            }
            setTimeout(() => {
                this.notification.classList.remove('show');
            }, 3000);
        }

        handleWindowResize() {
            if (this.isCallMinimized) {
                const rect = this.callScreen.getBoundingClientRect();
                const maxX = window.innerWidth - this.callScreen.offsetWidth - 10;
                const maxY = window.innerHeight - this.callScreen.offsetHeight - 10;
                if (rect.left > maxX || rect.top > maxY) {
                    this.callScreen.style.left = Math.max(10, Math.min(rect.left, maxX)) + 'px';
                    this.callScreen.style.top = Math.max(10, Math.min(rect.top, maxY)) + 'px';
                }
            }
            if (window.innerWidth > 768) {
                this.toggleSidebar(false);
            }
        }

        cleanup() {
            this.clearCallInterval();
            if (this.isAuthenticated && this.userData) {
                localStorage.setItem('user_data', JSON.stringify(this.userData));
            }
        }

        resetCallControls() {
            this.callMuteBtn.classList.remove('active');
            this.callMuteBtn.querySelector('i').className = 'fas fa-microphone';
            this.callSpeakerBtn.classList.remove('active');
            this.callSpeakerBtn.querySelector('i').className = 'fas fa-volume-up';
        }

        resetCallScreenPosition() {
            this.callScreen.style.left = '0';
            this.callScreen.style.top = '0';
            this.callScreen.style.right = 'auto';
            this.callScreen.style.bottom = 'auto';
            this.callScreen.style.transform = 'none';
        }

        escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        new FlimeMessenger();
    });
</script>
